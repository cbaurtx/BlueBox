\doxysection{shrpx\+\_\+connection\+\_\+handler.\+h}
\hypertarget{shrpx__connection__handler_8h_source}{}\label{shrpx__connection__handler_8h_source}\index{managed\_components/espressif\_\_nghttp/nghttp2/src/shrpx\_connection\_handler.h@{managed\_components/espressif\_\_nghttp/nghttp2/src/shrpx\_connection\_handler.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ *\ nghttp2\ -\/\ HTTP/2\ C\ Library}}
\DoxyCodeLine{00003\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ *\ Copyright\ (c)\ 2012\ Tatsuhiro\ Tsujikawa}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ *\ Permission\ is\ hereby\ granted,\ free\ of\ charge,\ to\ any\ person\ obtaining}}
\DoxyCodeLine{00007\ \textcolor{comment}{\ *\ a\ copy\ of\ this\ software\ and\ associated\ documentation\ files\ (the}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ *\ "{}Software"{}),\ to\ deal\ in\ the\ Software\ without\ restriction,\ including}}
\DoxyCodeLine{00009\ \textcolor{comment}{\ *\ without\ limitation\ the\ rights\ to\ use,\ copy,\ modify,\ merge,\ publish,}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ *\ distribute,\ sublicense,\ and/or\ sell\ copies\ of\ the\ Software,\ and\ to}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ *\ permit\ persons\ to\ whom\ the\ Software\ is\ furnished\ to\ do\ so,\ subject\ to}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ *\ the\ following\ conditions:}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ *\ The\ above\ copyright\ notice\ and\ this\ permission\ notice\ shall\ be}}
\DoxyCodeLine{00015\ \textcolor{comment}{\ *\ included\ in\ all\ copies\ or\ substantial\ portions\ of\ the\ Software.}}
\DoxyCodeLine{00016\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00017\ \textcolor{comment}{\ *\ THE\ SOFTWARE\ IS\ PROVIDED\ "{}AS\ IS"{},\ WITHOUT\ WARRANTY\ OF\ ANY\ KIND,}}
\DoxyCodeLine{00018\ \textcolor{comment}{\ *\ EXPRESS\ OR\ IMPLIED,\ INCLUDING\ BUT\ NOT\ LIMITED\ TO\ THE\ WARRANTIES\ OF}}
\DoxyCodeLine{00019\ \textcolor{comment}{\ *\ MERCHANTABILITY,\ FITNESS\ FOR\ A\ PARTICULAR\ PURPOSE\ AND}}
\DoxyCodeLine{00020\ \textcolor{comment}{\ *\ NONINFRINGEMENT.\ IN\ NO\ EVENT\ SHALL\ THE\ AUTHORS\ OR\ COPYRIGHT\ HOLDERS\ BE}}
\DoxyCodeLine{00021\ \textcolor{comment}{\ *\ LIABLE\ FOR\ ANY\ CLAIM,\ DAMAGES\ OR\ OTHER\ LIABILITY,\ WHETHER\ IN\ AN\ ACTION}}
\DoxyCodeLine{00022\ \textcolor{comment}{\ *\ OF\ CONTRACT,\ TORT\ OR\ OTHERWISE,\ ARISING\ FROM,\ OUT\ OF\ OR\ IN\ CONNECTION}}
\DoxyCodeLine{00023\ \textcolor{comment}{\ *\ WITH\ THE\ SOFTWARE\ OR\ THE\ USE\ OR\ OTHER\ DEALINGS\ IN\ THE\ SOFTWARE.}}
\DoxyCodeLine{00024\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#ifndef\ SHRPX\_CONNECTION\_HANDLER\_H}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#define\ SHRPX\_CONNECTION\_HANDLER\_H}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}shrpx.h"{}}}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ <sys/types.h>}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#ifdef\ HAVE\_SYS\_SOCKET\_H}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#\ \ include\ <sys/socket.h>}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_SYS\_SOCKET\_H}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#include\ <mutex>}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#include\ <memory>}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#include\ <random>}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#ifndef\ NOTHREADS}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#\ \ include\ <future>}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ NOTHREADS}}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \textcolor{preprocessor}{\#ifdef\ HAVE\_LIBBPF}}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#\ \ include\ <bpf/libbpf.h>}}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_LIBBPF}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \textcolor{preprocessor}{\#include\ "{}ssl\_compat.h"{}}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \textcolor{preprocessor}{\#ifdef\ NGHTTP2\_OPENSSL\_IS\_WOLFSSL}}
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#\ \ include\ <wolfssl/options.h>}}
\DoxyCodeLine{00051\ \textcolor{preprocessor}{\#\ \ include\ <wolfssl/openssl/ssl.h>}}
\DoxyCodeLine{00052\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{//\ !NGHTTP2\_OPENSSL\_IS\_WOLFSSL}}
\DoxyCodeLine{00053\ \textcolor{preprocessor}{\#\ \ include\ <openssl/ssl.h>}}
\DoxyCodeLine{00054\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ !NGHTTP2\_OPENSSL\_IS\_WOLFSSL}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \textcolor{preprocessor}{\#include\ <ev.h>}}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \textcolor{preprocessor}{\#ifdef\ HAVE\_NEVERBLEED}}
\DoxyCodeLine{00059\ \textcolor{preprocessor}{\#\ \ include\ <neverbleed.h>}}
\DoxyCodeLine{00060\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_NEVERBLEED}}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \textcolor{preprocessor}{\#include\ "{}shrpx\_downstream\_connection\_pool.h"{}}}
\DoxyCodeLine{00063\ \textcolor{preprocessor}{\#include\ "{}shrpx\_config.h"{}}}
\DoxyCodeLine{00064\ \textcolor{preprocessor}{\#include\ "{}shrpx\_exec.h"{}}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \textcolor{keyword}{namespace\ }shrpx\ \{}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classshrpx_1_1Http2Session}{Http2Session}};}
\DoxyCodeLine{00069\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classshrpx_1_1ConnectBlocker}{ConnectBlocker}};}
\DoxyCodeLine{00070\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classshrpx_1_1AcceptHandler}{AcceptHandler}};}
\DoxyCodeLine{00071\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classshrpx_1_1Worker}{Worker}};}
\DoxyCodeLine{00072\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structshrpx_1_1WorkerStat}{WorkerStat}};}
\DoxyCodeLine{00073\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structshrpx_1_1TicketKeys}{TicketKeys}};}
\DoxyCodeLine{00074\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classshrpx_1_1MemcachedDispatcher}{MemcachedDispatcher}};}
\DoxyCodeLine{00075\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structshrpx_1_1UpstreamAddr}{UpstreamAddr}};}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \textcolor{keyword}{namespace\ }tls\ \{}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classshrpx_1_1tls_1_1CertLookupTree}{CertLookupTree}};}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \}\ \textcolor{comment}{//\ namespace\ tls}}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structshrpx_1_1OCSPUpdateContext}{OCSPUpdateContext}}\ \{}
\DoxyCodeLine{00084\ \ \ \textcolor{comment}{//\ ocsp\ response\ buffer}}
\DoxyCodeLine{00085\ \ \ std::vector<uint8\_t>\ resp;}
\DoxyCodeLine{00086\ \ \ \textcolor{comment}{//\ Process\ running\ fetch-\/ocsp-\/response\ script}}
\DoxyCodeLine{00087\ \ \ \mbox{\hyperlink{structshrpx_1_1Process}{Process}}\ proc;}
\DoxyCodeLine{00088\ \ \ \textcolor{comment}{//\ index\ to\ ConnectionHandler::all\_ssl\_ctx\_,\ which\ points\ to\ next}}
\DoxyCodeLine{00089\ \ \ \textcolor{comment}{//\ SSL\_CTX\ to\ update\ ocsp\ response\ cache.}}
\DoxyCodeLine{00090\ \ \ \textcolor{keywordtype}{size\_t}\ next;}
\DoxyCodeLine{00091\ \ \ ev\_child\ chldev;}
\DoxyCodeLine{00092\ \ \ ev\_io\ rev;}
\DoxyCodeLine{00093\ \ \ \textcolor{comment}{//\ errno\ encountered\ while\ processing\ response}}
\DoxyCodeLine{00094\ \ \ \textcolor{keywordtype}{int}\ error;}
\DoxyCodeLine{00095\ \};}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \textcolor{comment}{//\ SerialEvent\ is\ an\ event\ sent\ from\ Worker\ thread.}}
\DoxyCodeLine{00098\ \textcolor{keyword}{enum\ class}\ SerialEventType\ \{}
\DoxyCodeLine{00099\ \ \ NONE,}
\DoxyCodeLine{00100\ \ \ REPLACE\_DOWNSTREAM,}
\DoxyCodeLine{00101\ \};}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \textcolor{keyword}{struct\ }SerialEvent\ \{}
\DoxyCodeLine{00104\ \ \ \textcolor{comment}{//\ ctor\ for\ event\ uses\ DownstreamConfig}}
\DoxyCodeLine{00105\ \ \ SerialEvent(SerialEventType\ type,}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::shared\_ptr<DownstreamConfig>\ \&downstreamconf)}
\DoxyCodeLine{00107\ \ \ \ \ :\ type(type),\ downstreamconf(downstreamconf)\ \{\}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ SerialEventType\ type;}
\DoxyCodeLine{00110\ \ \ std::shared\_ptr<DownstreamConfig>\ downstreamconf;}
\DoxyCodeLine{00111\ \};}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \textcolor{preprocessor}{\#ifdef\ ENABLE\_HTTP3}}
\DoxyCodeLine{00114\ \textcolor{preprocessor}{\#\ \ ifdef\ HAVE\_LIBBPF}}
\DoxyCodeLine{00115\ \textcolor{keyword}{struct\ }BPFRef\ \{}
\DoxyCodeLine{00116\ \ \ bpf\_object\ *obj;}
\DoxyCodeLine{00117\ \ \ bpf\_map\ *reuseport\_array;}
\DoxyCodeLine{00118\ \ \ bpf\_map\ *worker\_id\_map;}
\DoxyCodeLine{00119\ \};}
\DoxyCodeLine{00120\ \textcolor{preprocessor}{\#\ \ endif\ }\textcolor{comment}{//\ HAVE\_LIBBPF}}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \textcolor{comment}{//\ QUIC\ IPC\ message\ type.}}
\DoxyCodeLine{00123\ \textcolor{keyword}{enum\ class}\ QUICIPCType\ \{}
\DoxyCodeLine{00124\ \ \ NONE,}
\DoxyCodeLine{00125\ \ \ \textcolor{comment}{//\ Send\ forwarded\ QUIC\ UDP\ datagram\ and\ its\ metadata.}}
\DoxyCodeLine{00126\ \ \ DGRAM\_FORWARD,}
\DoxyCodeLine{00127\ \};}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00129\ \textcolor{comment}{//\ WorkerProcesses\ which\ are\ in\ graceful\ shutdown\ period.}}
\DoxyCodeLine{00130\ \textcolor{keyword}{struct\ }QUICLingeringWorkerProcess\ \{}
\DoxyCodeLine{00131\ \ \ QUICLingeringWorkerProcess(std::vector<WorkerID>\ worker\_ids,\ \textcolor{keywordtype}{int}\ quic\_ipc\_fd)}
\DoxyCodeLine{00132\ \ \ \ \ :\ worker\_ids\{std::move(worker\_ids)\},\ quic\_ipc\_fd\{quic\_ipc\_fd\}\ \{\}}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \ \ std::vector<WorkerID>\ worker\_ids;}
\DoxyCodeLine{00135\ \ \ \textcolor{comment}{//\ Socket\ to\ send\ QUIC\ IPC\ message\ to\ this\ worker\ process.}}
\DoxyCodeLine{00136\ \ \ \textcolor{keywordtype}{int}\ quic\_ipc\_fd;}
\DoxyCodeLine{00137\ \};}
\DoxyCodeLine{00138\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ ENABLE\_HTTP3}}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \textcolor{keyword}{class\ }ConnectionHandler\ \{}
\DoxyCodeLine{00141\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00142\ \ \ ConnectionHandler(\textcolor{keyword}{struct}\ ev\_loop\ *loop,\ std::mt19937\ \&gen);}
\DoxyCodeLine{00143\ \ \ \string~ConnectionHandler();}
\DoxyCodeLine{00144\ \ \ \textcolor{keywordtype}{int}\ handle\_connection(\textcolor{keywordtype}{int}\ fd,\ sockaddr\ *addr,\ \textcolor{keywordtype}{int}\ addrlen,}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structshrpx_1_1UpstreamAddr}{UpstreamAddr}}\ *faddr);}
\DoxyCodeLine{00146\ \ \ \textcolor{comment}{//\ Creates\ Worker\ object\ for\ single\ threaded\ configuration.}}
\DoxyCodeLine{00147\ \ \ \textcolor{keywordtype}{int}\ create\_single\_worker();}
\DoxyCodeLine{00148\ \ \ \textcolor{comment}{//\ Creates\ |num|\ Worker\ objects\ for\ multi\ threaded\ configuration.}}
\DoxyCodeLine{00149\ \ \ \textcolor{comment}{//\ The\ |num|\ must\ be\ strictly\ more\ than\ 1.}}
\DoxyCodeLine{00150\ \ \ \textcolor{keywordtype}{int}\ create\_worker\_thread(\textcolor{keywordtype}{size\_t}\ num);}
\DoxyCodeLine{00151\ \ \ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00152\ \ \ set\_ticket\_keys\_to\_worker(\textcolor{keyword}{const}\ std::shared\_ptr<TicketKeys>\ \&ticket\_keys);}
\DoxyCodeLine{00153\ \ \ \textcolor{keywordtype}{void}\ worker\_reopen\_log\_files();}
\DoxyCodeLine{00154\ \ \ \textcolor{keywordtype}{void}\ set\_ticket\_keys(std::shared\_ptr<TicketKeys>\ ticket\_keys);}
\DoxyCodeLine{00155\ \ \ \textcolor{keyword}{const}\ std::shared\_ptr<TicketKeys>\ \&get\_ticket\_keys()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00156\ \ \ \textcolor{keyword}{struct\ }ev\_loop\ *get\_loop()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00157\ \ \ \mbox{\hyperlink{classshrpx_1_1Worker}{Worker}}\ *get\_single\_worker()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00158\ \ \ \textcolor{keywordtype}{void}\ add\_acceptor(std::unique\_ptr<AcceptHandler>\ h);}
\DoxyCodeLine{00159\ \ \ \textcolor{keywordtype}{void}\ delete\_acceptor();}
\DoxyCodeLine{00160\ \ \ \textcolor{keywordtype}{void}\ enable\_acceptor();}
\DoxyCodeLine{00161\ \ \ \textcolor{keywordtype}{void}\ disable\_acceptor();}
\DoxyCodeLine{00162\ \ \ \textcolor{keywordtype}{void}\ sleep\_acceptor(ev\_tstamp\ t);}
\DoxyCodeLine{00163\ \ \ \textcolor{keywordtype}{void}\ accept\_pending\_connection();}
\DoxyCodeLine{00164\ \ \ \textcolor{keywordtype}{void}\ graceful\_shutdown\_worker();}
\DoxyCodeLine{00165\ \ \ \textcolor{keywordtype}{void}\ set\_graceful\_shutdown(\textcolor{keywordtype}{bool}\ f);}
\DoxyCodeLine{00166\ \ \ \textcolor{keywordtype}{bool}\ get\_graceful\_shutdown()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00167\ \ \ \textcolor{keywordtype}{void}\ join\_worker();}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00169\ \ \ \textcolor{comment}{//\ Cancels\ ocsp\ update\ process}}
\DoxyCodeLine{00170\ \ \ \textcolor{keywordtype}{void}\ cancel\_ocsp\_update();}
\DoxyCodeLine{00171\ \ \ \textcolor{comment}{//\ Starts\ ocsp\ update\ for\ certificate\ |cert\_file|.}}
\DoxyCodeLine{00172\ \ \ \textcolor{keywordtype}{int}\ start\_ocsp\_update(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *cert\_file);}
\DoxyCodeLine{00173\ \ \ \textcolor{comment}{//\ Reads\ incoming\ data\ from\ ocsp\ update\ process}}
\DoxyCodeLine{00174\ \ \ \textcolor{keywordtype}{void}\ read\_ocsp\_chunk();}
\DoxyCodeLine{00175\ \ \ \textcolor{comment}{//\ Handles\ the\ completion\ of\ one\ ocsp\ update}}
\DoxyCodeLine{00176\ \ \ \textcolor{keywordtype}{void}\ handle\_ocsp\_complete();}
\DoxyCodeLine{00177\ \ \ \textcolor{comment}{//\ Resets\ ocsp\_;}}
\DoxyCodeLine{00178\ \ \ \textcolor{keywordtype}{void}\ reset\_ocsp();}
\DoxyCodeLine{00179\ \ \ \textcolor{comment}{//\ Proceeds\ to\ the\ next\ certificate's\ ocsp\ update.\ \ If\ all}}
\DoxyCodeLine{00180\ \ \ \textcolor{comment}{//\ certificates'\ ocsp\ update\ has\ been\ done,\ schedule\ next\ ocsp}}
\DoxyCodeLine{00181\ \ \ \textcolor{comment}{//\ update.}}
\DoxyCodeLine{00182\ \ \ \textcolor{keywordtype}{void}\ proceed\_next\_cert\_ocsp();}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00184\ \ \ \textcolor{keywordtype}{void}\ set\_tls\_ticket\_key\_memcached\_dispatcher(}
\DoxyCodeLine{00185\ \ \ \ \ std::unique\_ptr<MemcachedDispatcher>\ dispatcher);}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00187\ \ \ \mbox{\hyperlink{classshrpx_1_1MemcachedDispatcher}{MemcachedDispatcher}}\ *get\_tls\_ticket\_key\_memcached\_dispatcher()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00188\ \ \ \textcolor{keywordtype}{void}\ on\_tls\_ticket\_key\_network\_error(ev\_timer\ *w);}
\DoxyCodeLine{00189\ \ \ \textcolor{keywordtype}{void}\ on\_tls\_ticket\_key\_not\_found(ev\_timer\ *w);}
\DoxyCodeLine{00190\ \ \ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00191\ \ \ on\_tls\_ticket\_key\_get\_success(\textcolor{keyword}{const}\ std::shared\_ptr<TicketKeys>\ \&ticket\_keys,}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ev\_timer\ *w);}
\DoxyCodeLine{00193\ \ \ \textcolor{keywordtype}{void}\ schedule\_next\_tls\_ticket\_key\_memcached\_get(ev\_timer\ *w);}
\DoxyCodeLine{00194\ \ \ SSL\_CTX\ *create\_tls\_ticket\_key\_memcached\_ssl\_ctx();}
\DoxyCodeLine{00195\ \ \ \textcolor{comment}{//\ Returns\ the\ SSL\_CTX\ at\ all\_ssl\_ctx\_[idx].\ \ This\ does\ not\ perform}}
\DoxyCodeLine{00196\ \ \ \textcolor{comment}{//\ array\ bound\ checking.}}
\DoxyCodeLine{00197\ \ \ SSL\_CTX\ *get\_ssl\_ctx(\textcolor{keywordtype}{size\_t}\ idx)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ \textcolor{keyword}{const}\ std::vector<SSL\_CTX\ *>\ \&get\_indexed\_ssl\_ctx(\textcolor{keywordtype}{size\_t}\ idx)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00200\ \textcolor{preprocessor}{\#ifdef\ ENABLE\_HTTP3}}
\DoxyCodeLine{00201\ \ \ \textcolor{keyword}{const}\ std::vector<SSL\_CTX\ *>\ \&get\_quic\_indexed\_ssl\_ctx(\textcolor{keywordtype}{size\_t}\ idx)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \ \ \textcolor{keywordtype}{int}\ forward\_quic\_packet(\textcolor{keyword}{const}\ \mbox{\hyperlink{structshrpx_1_1UpstreamAddr}{UpstreamAddr}}\ *faddr,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structnghttp2_1_1Address}{Address}}\ \&remote\_addr,}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structnghttp2_1_1Address}{Address}}\ \&local\_addr,\ \textcolor{keyword}{const}\ ngtcp2\_pkt\_info\ \&pi,}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structshrpx_1_1WorkerID}{WorkerID}}\ \&wid,\ std::span<const\ uint8\_t>\ data);}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ \textcolor{keywordtype}{void}\ set\_quic\_keying\_materials(std::shared\_ptr<QUICKeyingMaterials>\ qkms);}
\DoxyCodeLine{00208\ \ \ \textcolor{keyword}{const}\ std::shared\_ptr<QUICKeyingMaterials>\ \&get\_quic\_keying\_materials()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \textcolor{keywordtype}{void}\ set\_worker\_ids(std::vector<WorkerID>\ worker\_ids);}
\DoxyCodeLine{00211\ \ \ \mbox{\hyperlink{classshrpx_1_1Worker}{Worker}}\ *find\_worker(\textcolor{keyword}{const}\ \mbox{\hyperlink{structshrpx_1_1WorkerID}{WorkerID}}\ \&wid)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ \textcolor{keywordtype}{void}\ set\_quic\_lingering\_worker\_processes(}
\DoxyCodeLine{00214\ \ \ \ \ \textcolor{keyword}{const}\ std::vector<QUICLingeringWorkerProcess>\ \&quic\_lwps);}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00216\ \ \ \textcolor{comment}{//\ Return\ matching\ QUICLingeringWorkerProcess\ which\ has\ a\ Worker\ ID}}
\DoxyCodeLine{00217\ \ \ \textcolor{comment}{//\ such\ that\ |dcid|\ starts\ with\ it.\ \ If\ no\ such}}
\DoxyCodeLine{00218\ \ \ \textcolor{comment}{//\ QUICLingeringWorkerProcess,\ it\ returns\ nullptr.}}
\DoxyCodeLine{00219\ \ \ QUICLingeringWorkerProcess\ *}
\DoxyCodeLine{00220\ \ \ match\_quic\_lingering\_worker\_process\_worker\_id(\textcolor{keyword}{const}\ \mbox{\hyperlink{structshrpx_1_1WorkerID}{WorkerID}}\ \&wid);}
\DoxyCodeLine{00221\ }
\DoxyCodeLine{00222\ \ \ \textcolor{keywordtype}{int}\ forward\_quic\_packet\_to\_lingering\_worker\_process(}
\DoxyCodeLine{00223\ \ \ \ \ QUICLingeringWorkerProcess\ *quic\_lwp,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structnghttp2_1_1Address}{Address}}\ \&remote\_addr,}
\DoxyCodeLine{00224\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structnghttp2_1_1Address}{Address}}\ \&local\_addr,\ \textcolor{keyword}{const}\ ngtcp2\_pkt\_info\ \&pi,}
\DoxyCodeLine{00225\ \ \ \ \ std::span<const\ uint8\_t>\ data);}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00227\ \ \ \textcolor{keywordtype}{void}\ set\_quic\_ipc\_fd(\textcolor{keywordtype}{int}\ fd);}
\DoxyCodeLine{00228\ }
\DoxyCodeLine{00229\ \ \ \textcolor{keywordtype}{int}\ quic\_ipc\_read();}
\DoxyCodeLine{00230\ }
\DoxyCodeLine{00231\ \textcolor{preprocessor}{\#\ \ ifdef\ HAVE\_LIBBPF}}
\DoxyCodeLine{00232\ \ \ std::vector<BPFRef>\ \&get\_quic\_bpf\_refs();}
\DoxyCodeLine{00233\ \ \ \textcolor{keywordtype}{void}\ unload\_bpf\_objects();}
\DoxyCodeLine{00234\ \textcolor{preprocessor}{\#\ \ endif\ }\textcolor{comment}{//\ HAVE\_LIBBPF}}
\DoxyCodeLine{00235\ \textcolor{preprocessor}{\#endif\ \ \ }\textcolor{comment}{//\ ENABLE\_HTTP3}}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00237\ \textcolor{preprocessor}{\#ifdef\ HAVE\_NEVERBLEED}}
\DoxyCodeLine{00238\ \ \ \textcolor{keywordtype}{void}\ set\_neverbleed(neverbleed\_t\ *nb);}
\DoxyCodeLine{00239\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_NEVERBLEED}}
\DoxyCodeLine{00240\ }
\DoxyCodeLine{00241\ \ \ \textcolor{comment}{//\ Send\ SerialEvent\ SerialEventType::REPLACE\_DOWNSTREAM\ to\ this}}
\DoxyCodeLine{00242\ \ \ \textcolor{comment}{//\ object.}}
\DoxyCodeLine{00243\ \ \ \textcolor{keywordtype}{void}\ send\_replace\_downstream(}
\DoxyCodeLine{00244\ \ \ \ \ \textcolor{keyword}{const}\ std::shared\_ptr<DownstreamConfig>\ \&downstreamconf);}
\DoxyCodeLine{00245\ \ \ \textcolor{comment}{//\ Internal\ function\ to\ send\ |ev|\ to\ this\ object.}}
\DoxyCodeLine{00246\ \ \ \textcolor{keywordtype}{void}\ send\_serial\_event(\mbox{\hyperlink{structshrpx_1_1SerialEvent}{SerialEvent}}\ ev);}
\DoxyCodeLine{00247\ \ \ \textcolor{comment}{//\ Handles\ SerialEvents\ received.}}
\DoxyCodeLine{00248\ \ \ \textcolor{keywordtype}{void}\ handle\_serial\_event();}
\DoxyCodeLine{00249\ \ \ \textcolor{comment}{//\ Sends\ WorkerEvent\ to\ make\ them\ replace\ downstream.}}
\DoxyCodeLine{00250\ \ \ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00251\ \ \ worker\_replace\_downstream(std::shared\_ptr<DownstreamConfig>\ downstreamconf);}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ \ \ \textcolor{keywordtype}{void}\ set\_enable\_acceptor\_on\_ocsp\_completion(\textcolor{keywordtype}{bool}\ f);}
\DoxyCodeLine{00254\ }
\DoxyCodeLine{00255\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00256\ \ \ \textcolor{comment}{//\ Stores\ all\ SSL\_CTX\ objects.}}
\DoxyCodeLine{00257\ \ \ std::vector<SSL\_CTX\ *>\ all\_ssl\_ctx\_;}
\DoxyCodeLine{00258\ \ \ \textcolor{comment}{//\ Stores\ all\ SSL\_CTX\ objects\ in\ a\ way\ that\ its\ index\ is\ stored\ in}}
\DoxyCodeLine{00259\ \ \ \textcolor{comment}{//\ cert\_tree.\ \ The\ SSL\_CTXs\ stored\ in\ the\ same\ index\ share\ the\ same}}
\DoxyCodeLine{00260\ \ \ \textcolor{comment}{//\ hostname,\ but\ could\ have\ different\ signature\ algorithm.\ \ The}}
\DoxyCodeLine{00261\ \ \ \textcolor{comment}{//\ selection\ among\ them\ are\ performed\ by\ hostname\ presented\ by\ SNI,}}
\DoxyCodeLine{00262\ \ \ \textcolor{comment}{//\ and\ signature\ algorithm\ presented\ by\ client.}}
\DoxyCodeLine{00263\ \ \ std::vector<std::vector<SSL\_CTX\ *>>\ indexed\_ssl\_ctx\_;}
\DoxyCodeLine{00264\ \textcolor{preprocessor}{\#ifdef\ ENABLE\_HTTP3}}
\DoxyCodeLine{00265\ \ \ std::vector<WorkerID>\ worker\_ids\_;}
\DoxyCodeLine{00266\ \ \ std::vector<WorkerID>\ lingering\_worker\_ids\_;}
\DoxyCodeLine{00267\ \ \ \textcolor{keywordtype}{int}\ quic\_ipc\_fd\_;}
\DoxyCodeLine{00268\ \ \ std::vector<QUICLingeringWorkerProcess>\ quic\_lingering\_worker\_processes\_;}
\DoxyCodeLine{00269\ \textcolor{preprocessor}{\#\ \ ifdef\ HAVE\_LIBBPF}}
\DoxyCodeLine{00270\ \ \ std::vector<BPFRef>\ quic\_bpf\_refs\_;}
\DoxyCodeLine{00271\ \textcolor{preprocessor}{\#\ \ endif\ }\textcolor{comment}{//\ HAVE\_LIBBPF}}
\DoxyCodeLine{00272\ \ \ std::shared\_ptr<QUICKeyingMaterials>\ quic\_keying\_materials\_;}
\DoxyCodeLine{00273\ \ \ std::vector<SSL\_CTX\ *>\ quic\_all\_ssl\_ctx\_;}
\DoxyCodeLine{00274\ \ \ std::vector<std::vector<SSL\_CTX\ *>>\ quic\_indexed\_ssl\_ctx\_;}
\DoxyCodeLine{00275\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ ENABLE\_HTTP3}}
\DoxyCodeLine{00276\ \ \ \mbox{\hyperlink{structshrpx_1_1OCSPUpdateContext}{OCSPUpdateContext}}\ ocsp\_;}
\DoxyCodeLine{00277\ \ \ std::mt19937\ \&gen\_;}
\DoxyCodeLine{00278\ \ \ \textcolor{comment}{//\ ev\_loop\ for\ each\ worker}}
\DoxyCodeLine{00279\ \ \ std::vector<struct\ ev\_loop\ *>\ worker\_loops\_;}
\DoxyCodeLine{00280\ \ \ \textcolor{comment}{//\ Worker\ instances\ when\ multi\ threaded\ mode\ (-\/nN,\ N\ >=\ 2)\ is\ used.}}
\DoxyCodeLine{00281\ \ \ \textcolor{comment}{//\ If\ at\ least\ one\ frontend\ enables\ API\ request,\ we\ allocate\ 1}}
\DoxyCodeLine{00282\ \ \ \textcolor{comment}{//\ additional\ worker\ dedicated\ to\ API\ request\ .}}
\DoxyCodeLine{00283\ \ \ std::vector<std::unique\_ptr<Worker>>\ workers\_;}
\DoxyCodeLine{00284\ \ \ \textcolor{comment}{//\ mutex\ for\ serial\ event\ resive\ buffer\ handling}}
\DoxyCodeLine{00285\ \ \ std::mutex\ serial\_event\_mu\_;}
\DoxyCodeLine{00286\ \ \ \textcolor{comment}{//\ SerialEvent\ receive\ buffer}}
\DoxyCodeLine{00287\ \ \ std::vector<SerialEvent>\ serial\_events\_;}
\DoxyCodeLine{00288\ \ \ \textcolor{comment}{//\ Worker\ instance\ used\ when\ single\ threaded\ mode\ (-\/n1)\ is\ used.}}
\DoxyCodeLine{00289\ \ \ \textcolor{comment}{//\ Otherwise,\ nullptr\ and\ workers\_\ has\ instances\ of\ Worker\ instead.}}
\DoxyCodeLine{00290\ \ \ std::unique\_ptr<Worker>\ single\_worker\_;}
\DoxyCodeLine{00291\ \ \ std::unique\_ptr<tls::CertLookupTree>\ cert\_tree\_;}
\DoxyCodeLine{00292\ \textcolor{preprocessor}{\#ifdef\ ENABLE\_HTTP3}}
\DoxyCodeLine{00293\ \ \ std::unique\_ptr<tls::CertLookupTree>\ quic\_cert\_tree\_;}
\DoxyCodeLine{00294\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ ENABLE\_HTTP3}}
\DoxyCodeLine{00295\ \ \ std::unique\_ptr<MemcachedDispatcher>\ tls\_ticket\_key\_memcached\_dispatcher\_;}
\DoxyCodeLine{00296\ \ \ \textcolor{comment}{//\ Current\ TLS\ session\ ticket\ keys.\ \ Note\ that\ TLS\ connection\ does}}
\DoxyCodeLine{00297\ \ \ \textcolor{comment}{//\ not\ refer\ to\ this\ field\ directly.\ \ They\ use\ TicketKeys\ object\ in}}
\DoxyCodeLine{00298\ \ \ \textcolor{comment}{//\ Worker\ object.}}
\DoxyCodeLine{00299\ \ \ std::shared\_ptr<TicketKeys>\ ticket\_keys\_;}
\DoxyCodeLine{00300\ \ \ \textcolor{keyword}{struct\ }ev\_loop\ *loop\_;}
\DoxyCodeLine{00301\ \ \ std::vector<std::unique\_ptr<AcceptHandler>>\ acceptors\_;}
\DoxyCodeLine{00302\ \textcolor{preprocessor}{\#ifdef\ HAVE\_NEVERBLEED}}
\DoxyCodeLine{00303\ \ \ neverbleed\_t\ *nb\_;}
\DoxyCodeLine{00304\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_NEVERBLEED}}
\DoxyCodeLine{00305\ \ \ ev\_timer\ disable\_acceptor\_timer\_;}
\DoxyCodeLine{00306\ \ \ ev\_timer\ ocsp\_timer\_;}
\DoxyCodeLine{00307\ \ \ ev\_async\ thread\_join\_asyncev\_;}
\DoxyCodeLine{00308\ \ \ ev\_async\ serial\_event\_asyncev\_;}
\DoxyCodeLine{00309\ \textcolor{preprocessor}{\#ifndef\ NOTHREADS}}
\DoxyCodeLine{00310\ \ \ std::future<void>\ thread\_join\_fut\_;}
\DoxyCodeLine{00311\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ NOTHREADS}}
\DoxyCodeLine{00312\ \ \ \textcolor{keywordtype}{size\_t}\ tls\_ticket\_key\_memcached\_get\_retry\_count\_;}
\DoxyCodeLine{00313\ \ \ \textcolor{keywordtype}{size\_t}\ tls\_ticket\_key\_memcached\_fail\_count\_;}
\DoxyCodeLine{00314\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ worker\_round\_robin\_cnt\_;}
\DoxyCodeLine{00315\ \ \ \textcolor{keywordtype}{bool}\ graceful\_shutdown\_;}
\DoxyCodeLine{00316\ \ \ \textcolor{comment}{//\ true\ if\ acceptors\ should\ be\ enabled\ after\ the\ initial\ ocsp\ update}}
\DoxyCodeLine{00317\ \ \ \textcolor{comment}{//\ has\ finished.}}
\DoxyCodeLine{00318\ \ \ \textcolor{keywordtype}{bool}\ enable\_acceptor\_on\_ocsp\_completion\_;}
\DoxyCodeLine{00319\ \};}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \}\ \textcolor{comment}{//\ namespace\ shrpx}}
\DoxyCodeLine{00322\ }
\DoxyCodeLine{00323\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ SHRPX\_CONNECTION\_HANDLER\_H}}

\end{DoxyCode}
