<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BlueBox: Compile</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">BlueBox<span id="projectnumber">&#160;0.9</span>
   </div>
   <div id="projectbrief">BlueBox Bluetooth sink</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Compile </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md279"></a></p>
<p>mruby uses Rake to compile and cross-compile all libraries and binaries.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md280"></a>
Prerequisites</h1>
<p>To compile mruby out of the source code you need the following tools:</p>
<ul>
<li>C Compiler (e.g. <span class="tt">gcc</span> or <span class="tt">clang</span>)</li>
<li>Linker (e.g. <span class="tt">gcc</span> or <span class="tt">clang</span>)</li>
<li>Archive utility (e.g. <span class="tt">ar</span>)</li>
<li>Ruby 2.5 or later (e.g. <span class="tt">ruby</span> or <span class="tt">jruby</span>)</li>
</ul>
<p>Optional:</p>
<ul>
<li>Git (to update mruby source and integrate mrbgems easier)</li>
<li>C++ compiler (to use mrbgems which include <span class="tt">*.cpp</span>, <span class="tt">*.cxx</span>, <span class="tt">*.cc</span>)</li>
<li>Bison (to compile <span class="tt">mrbgems/mruby-compiler/core/parse.y</span>)</li>
<li>gperf (to compile <span class="tt">mrbgems/mruby-compiler/core/keywords</span>)</li>
</ul>
<p>Note that <span class="tt">bison</span> bundled with macOS is too old to compile <span class="tt">mruby</span>. Try <span class="tt">brew install bison</span> and follow the instruction shown to update the <span class="tt">$PATH</span> to compile <span class="tt">mruby</span>. We also encourage you to upgrade <span class="tt">ruby</span> on macOS in similar manner.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md281"></a>
Build</h1>
<p>To compile <span class="tt">mruby</span> with the default build configuration, just invoke <span class="tt">rake</span> inside of the mruby source root. To generate and execute the test tools call <span class="tt">rake test</span>. To clean all build files call <span class="tt">rake clean</span>. To see full command line on build, call <span class="tt">rake -v</span>.</p>
<p>You can specify your own configuration file by the <span class="tt">MRUBY_CONFIG</span> environment variable (you can use <span class="tt">CONFIG</span> for shorthand for <span class="tt">MRUBY_CONFIG</span>). If the path doesn't exist, <span class="tt">build_config/${MRUBY_CONFIG}.rb</span> is used. The default configuration is defined in the <span class="tt">build_config/default.rb</span> file.</p>
<p>Those build configuration files contain the build configuration of mruby, for example:</p>
<div class="fragment"><div class="line">MRuby::Build.new do |conf|</div>
<div class="line">  conf.toolchain :gcc</div>
<div class="line">end</div>
</div><!-- fragment --><p>All tools necessary to compile mruby can be set or modified here.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md282"></a>
Build Configuration</h1>
<p>We wish you submit a pull-request to <span class="tt">build_config/PLATFORM.rb</span>, once you created a new configuration for a new platform.</p>
<p>Inside the configuration file, the following options can be configured based on your environment.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md283"></a>
Toolchains</h2>
<p>The mruby build system already contains a set of toolchain templates which configure the build environment for specific compiler infrastructures.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md284"></a>
GCC</h3>
<p>Toolchain configuration for the GNU C Compiler.</p>
<div class="fragment"><div class="line">conf.toolchain :gcc</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="autotoc_md285"></a>
clang</h3>
<p>Toolchain configuration for the LLVM C Compiler clang. Mainly equal to the GCC toolchain.</p>
<div class="fragment"><div class="line">conf.toolchain :clang</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="autotoc_md286"></a>
Visual Studio 2010, 2012 and 2013</h3>
<p>Toolchain configuration for Visual Studio on Windows. If you use the <a href="https://msdn.microsoft.com/en-us/library/ms229859(v=vs.110).aspx">Visual Studio Command Prompt</a>, you normally do not have to specify this manually, since it gets automatically detected by our build process.</p>
<div class="fragment"><div class="line">conf.toolchain :visualcpp</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="autotoc_md287"></a>
Android</h3>
<p>Toolchain configuration for Android.</p>
<div class="fragment"><div class="line">conf.toolchain :android</div>
</div><!-- fragment --><p>Requires the custom standalone Android NDK and the toolchain path in <span class="tt">ANDROID_STANDALONE_TOOLCHAIN</span>.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md288"></a>
Binaries</h2>
<p>It is possible to select which tools should be compiled during the compilation process. For example,</p>
<ul>
<li><span class="tt">mruby</span></li>
<li><span class="tt">mirb</span></li>
</ul>
<p>The configuration are done via <span class="tt">mrbgems</span>. See <span class="tt">Mrbgems</span> section.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md289"></a>
File Separator</h2>
<p>Some environments require a different file separator character. It is possible to set the character via <span class="tt">conf.file_separator</span>.</p>
<div class="fragment"><div class="line">conf.file_separator = &#39;/&#39;</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md290"></a>
C Compiler</h2>
<p>Configuration of the C compiler binary, flags and include paths.</p>
<div class="fragment"><div class="line">conf.cc do |cc|</div>
<div class="line">  cc.command = ...</div>
<div class="line">  cc.flags = ...</div>
<div class="line">  cc.include_paths = ...</div>
<div class="line">  cc.defines = ...</div>
<div class="line">  cc.option_include_path = ...</div>
<div class="line">  cc.option_define = ...</div>
<div class="line">  cc.compile_options = ...</div>
<div class="line">end</div>
</div><!-- fragment --><p>C Compiler has header searcher to detect installed library.</p>
<p>If you need an include path of header file use <span class="tt">search_header_path</span>:</p>
<div class="fragment"><div class="line"># Searches `iconv.h`.</div>
<div class="line"># If found it will return include path of the header file.</div>
<div class="line"># Otherwise it will return nil.</div>
<div class="line">fail &#39;iconv.h not found&#39; unless conf.cc.search_header_path &#39;iconv.h&#39;</div>
</div><!-- fragment --><p>If you need a full file name of header file use <span class="tt">search_header</span>:</p>
<div class="fragment"><div class="line"># Searches `iconv.h`.</div>
<div class="line"># If found it will return full path of the header file.</div>
<div class="line"># Otherwise it will return nil.</div>
<div class="line">iconv_h = conf.cc.search_header &#39;iconv.h&#39;</div>
<div class="line">print &quot;iconv.h found: #{iconv_h}\n&quot;</div>
</div><!-- fragment --><p>Header searcher uses compiler's <span class="tt">include_paths</span> by default. When you are using GCC toolchain (including clang toolchain since its base is gcc toolchain) it will use compiler specific include paths too. (For example <span class="tt">/usr/local/include</span>, <span class="tt">/usr/include</span>)</p>
<p>If you need a special header search paths define a singleton method <span class="tt">header_search_paths</span> to C compiler:</p>
<div class="fragment"><div class="line">def conf.cc.header_search_paths</div>
<div class="line">  [&#39;/opt/local/include&#39;] + include_paths</div>
<div class="line">end</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md291"></a>
Linker</h2>
<p>Configuration of the Linker binary, flags and library paths.</p>
<div class="fragment"><div class="line">conf.linker do |linker|</div>
<div class="line">  linker.command = ...</div>
<div class="line">  linker.flags = ...</div>
<div class="line">  linker.flags_before_libraries = ...</div>
<div class="line">  linker.libraries = ...</div>
<div class="line">  linker.flags_after_libraries = ...</div>
<div class="line">  linker.library_paths = ...</div>
<div class="line">  linker.option_library = ...</div>
<div class="line">  linker.option_library_path = ...</div>
<div class="line">  linker.link_options = ...</div>
<div class="line">end</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md292"></a>
Archiver</h2>
<p>Configuration of the Archiver binary and flags.</p>
<div class="fragment"><div class="line">conf.archiver do |archiver|</div>
<div class="line">  archiver.command = ...</div>
<div class="line">  archiver.archive_options = ...</div>
<div class="line">end</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md293"></a>
Parser Generator</h2>
<p>Configuration of the Parser Generator binary and flags.</p>
<div class="fragment"><div class="line">conf.yacc do |yacc|</div>
<div class="line">  yacc.command = ...</div>
<div class="line">  yacc.compile_options = ...</div>
<div class="line">end</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md294"></a>
GPerf</h2>
<p>Configuration of the GPerf binary and flags.</p>
<div class="fragment"><div class="line">conf.gperf do |gperf|</div>
<div class="line">  gperf.command = ...</div>
<div class="line">  gperf.compile_options = ...</div>
<div class="line">end</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md295"></a>
File Extensions</h2>
<div class="fragment"><div class="line">conf.exts do |exts|</div>
<div class="line">  exts.object = ...</div>
<div class="line">  exts.executable = ...</div>
<div class="line">  exts.library = ...</div>
<div class="line">end</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md296"></a>
Preallocated Symbols</h2>
<p>By far, preallocated symbols are highly compatible with the previous versions, so we expect you won't see any problem with them. But just in case you face any issue, you can disable preallocated symbols by specifying <span class="tt">conf.disable_presym</span>.</p>
<p>In the build process, <span class="tt">mrbc</span> under cross compiling environment will be compiled with this configuration.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md297"></a>
Mrbgems</h2>
<p><span class="tt">mruby</span> comes with the (sort of) packaging system named <span class="tt">mrbgems</span>. To specify <span class="tt">gem</span>, you can use <span class="tt">conf.gem</span> in the configuration file.</p>
<div class="fragment"><div class="line"># Integrate a bundled Gem you see in `mrbgems` directory</div>
<div class="line">conf.gem :core =&gt; &#39;mruby-something&#39;</div>
<div class="line"> </div>
<div class="line"># Integrate a Gem from GitHub</div>
<div class="line">conf.gem :github =&gt; &#39;someone/mruby-another&#39;</div>
<div class="line"> </div>
<div class="line"># Integrate a mruby binary Gem</div>
<div class="line">conf.gem :core =&gt; &#39;mruby-bin-mruby&#39;</div>
<div class="line"> </div>
<div class="line"># Integrate a interactive mruby binary Gem</div>
<div class="line">conf.gem :core =&gt; &#39;mruby-bin-mirb&#39;</div>
<div class="line"> </div>
<div class="line"># Integrate GemBox (set of Gems)</div>
<div class="line">conf.gembox &quot;default&quot;</div>
</div><!-- fragment --><p>A GemBox is a set of Gems defined in <span class="tt">mrbgems/default.gembox</span> for example. It's just a set of <span class="tt">mrbgem</span> configurations.</p>
<p>There is a <span class="tt">RubyGem</span> (gem for CRuby) named <span class="tt">mgem</span> that help you to manage <span class="tt">mrbgems</span>. Try <span class="tt">gem install mgem</span>. <span class="tt">mgem</span> can show you the list of registered <span class="tt">mrbgems</span>.</p>
<p>See <a class="el" href="md_managed__components_2espressif____nghttp_2nghttp2_2third-party_2mruby_2doc_2guides_2mrbgems.html">doc/guides/mrbgems.md</a> for more option about mrbgems.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md298"></a>
Mrbtest</h2>
<p>Configuration Mrbtest build process.</p>
<p>If you want <span class="tt">mrbtest.a</span> only, You should set <span class="tt">conf.build_mrbtest_lib_only</span></p>
<div class="fragment"><div class="line">conf.build_mrbtest_lib_only</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md299"></a>
Bintest</h2>
<p>Tests for mrbgem tools using CRuby. To have bintests place <span class="tt">*.rb</span> scripts to <span class="tt">bintest/</span> directory of mrbgems. See <span class="tt">mruby-bin-*/bintest/*.rb</span> if you need examples. If you want a temporary files use <span class="tt">tempfile</span> module of CRuby instead of <span class="tt">/tmp/</span>.</p>
<p>You can enable it with following:</p>
<div class="fragment"><div class="line">conf.enable_bintest</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md300"></a>
C++ ABI</h2>
<p>By default, mruby uses setjmp/longjmp to implement its exceptions. But it doesn't release C++ stack object correctly. To support mrbgems written in C++, mruby can be configured to use C++ exception.</p>
<p>There are two levels of C++ exception handling. The one is <span class="tt">enable_cxx_exception</span> that enables C++ exception, but uses C ABI. The other is <span class="tt">enable_cxx_abi</span> where all files are compiled by C++ compiler.</p>
<p>When you mix C++ code, C++ exception would be enabled automatically. If you need to enable C++ exception explicitly add the following:</p>
<div class="fragment"><div class="line">conf.enable_cxx_exception</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="autotoc_md301"></a>
C++ exception disabling</h3>
<p>If your compiler does not support C++, and you want to ensure you don't use mrbgem written in C++, you can explicitly disable C++ exception, add following:</p>
<div class="fragment"><div class="line">conf.disable_cxx_exception</div>
</div><!-- fragment --><p>and you will get an error when you try to use C++ gem. Note that it must be called before <span class="tt">enable_cxx_exception</span> or <span class="tt">gem</span> method.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md302"></a>
Debugging mode</h2>
<p>To enable debugging mode add the following:</p>
<div class="fragment"><div class="line">conf.enable_debug</div>
</div><!-- fragment --><p>When debugging mode is enabled</p>
<ul>
<li>Macro <span class="tt">MRB_DEBUG</span> would be defined.<ul>
<li>Which means <span class="tt">mrb_assert()</span> macro is enabled.</li>
</ul>
</li>
<li>Debug information of irep would be generated by <span class="tt">mrbc</span>.<ul>
<li>Because <span class="tt">-g</span> flag would be added to <span class="tt">mrbc</span> runner.<ul>
<li>You can have better backtrace of mruby scripts with this.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md303"></a>
Cross-Compilation</h1>
<p>mruby can also be cross-compiled from one platform to another. To achieve cross-compilation, the build configuration needs to contain an instance of <span class="tt">MRuby::CrossBuild</span>. This instance defines the compilation tools and flags for the target platform. An example could look like this:</p>
<div class="fragment"><div class="line">MRuby::CrossBuild.new(&#39;32bit&#39;) do |conf|</div>
<div class="line">  conf.toolchain :gcc</div>
<div class="line"> </div>
<div class="line">  conf.cc.flags &lt;&lt; &quot;-m32&quot;</div>
<div class="line">  conf.linker.flags &lt;&lt; &quot;-m32&quot;</div>
<div class="line">end</div>
</div><!-- fragment --><p>All configuration options of <span class="tt">MRuby::Build</span> can also be used in <span class="tt">MRuby::CrossBuild</span>. You can find examples under the <span class="tt">build_config</span> directory.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md304"></a>
Mrbtest in Cross-Compilation</h2>
<p>In cross compilation, you can run <span class="tt">mrbtest</span> on an emulator if you have it by changing configuration of test runner.</p>
<div class="fragment"><div class="line">conf.test_runner do |t|</div>
<div class="line">  t.command = ... # set emulator. this value must be non nil or false</div>
<div class="line">  t.flags = ... # set flags of emulator</div>
<div class="line"> </div>
<div class="line">  def t.run(bin) # override `run` if you need to change the behavior of it</div>
<div class="line">    ... # `bin` is the full path of mrbtest</div>
<div class="line">  end</div>
<div class="line">end</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md305"></a>
Build process</h1>
<p>During the build process the <span class="tt">build</span> directory will be created in the root directory. The structure of this directory will look like this:</p>
<div class="fragment"><div class="line">+- build</div>
<div class="line">    |</div>
<div class="line">    +- host</div>
<div class="line">        |</div>
<div class="line">        +- LEGAL        &lt;- License description</div>
<div class="line">        |</div>
<div class="line">        +- bin          &lt;- Binaries (mirb, mrbc and mruby)</div>
<div class="line">        |</div>
<div class="line">        +- lib          &lt;- Libraries (libmruby.a and libmruby_core.a)</div>
<div class="line">        |</div>
<div class="line">        +- mrbc         &lt;- Minimal mrbc place</div>
<div class="line">        |</div>
<div class="line">        +- mrbgems      &lt;- Compilation result from mrbgems</div>
<div class="line">        |</div>
<div class="line">        +- mrblib       &lt;- Compilation result from mrblib</div>
<div class="line">        |</div>
<div class="line">        +- src          &lt;- Compilation result from C sources</div>
</div><!-- fragment --><p>The compilation workflow will look like this:</p>
<ul>
<li>compile minimal <span class="tt">mrbc</span> from <span class="tt">src</span> and <span class="tt">mrblib</span> sources<ul>
<li>compile all files under <span class="tt">src</span> (object files will be stored in <span class="tt">build/host/mrbc/src</span>)</li>
<li>compile <span class="tt">mruby-compiler</span> gem</li>
<li>create <span class="tt">build/host/mrbc/lib/libmruby_core.a</span> out of all object files (C only)</li>
<li>create <span class="tt">build/host/mrbc/bin/mrbc</span> via <span class="tt">mruby-bin-mrbc</span> gem</li>
</ul>
</li>
<li>compile all files under <span class="tt">src</span> and store result in <span class="tt">build/host/src</span></li>
<li>create <span class="tt">build/host/mrblib/mrblib.c</span> by compiling all <span class="tt">*.rb</span> files under <span class="tt">mrblib</span> with <span class="tt">build/host/mrbc/bin/mrbc</span></li>
<li>compile <span class="tt">build/host/mrblib/mrblib.c</span> to <span class="tt">build/host/mrblib/mrblib.o</span></li>
<li>create <span class="tt">build/host/lib/libmruby.a</span> out of all object files (C and Ruby)</li>
<li>compile (normal) mrbgems specified in the configuration file</li>
<li>create <span class="tt">build/host/lib/libmruby.a</span> from object files from gems and <span class="tt">libmruby_core.a</span></li>
<li>create binary commands according to binary gems (e.g. <span class="tt">mirb</span> and <span class="tt">mruby</span>)</li>
<li>copy binaries under <span class="tt">build/host/bin</span> to <span class="tt">bin</span> directory</li>
</ul>
<div class="fragment"><div class="line"> _____    _____    ______    ____    ____    _____    _____    ____</div>
<div class="line">| CC  |-&gt;|GEN  |-&gt;|AR    |-&gt;|CC  |-&gt;|CC  |-&gt;|AR   |-&gt;|CC   |-&gt;|CC  |</div>
<div class="line">| *.c |  |y.tab|  |core.a|  |mrbc|  |*.rb|  |lib.a|  |mruby|  |mirb|</div>
<div class="line"> -----    -----    ------    ----    ----    -----    -----    ----</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md306"></a>
Cross-Compilation</h2>
<p>In case of a cross-compilation to <span class="tt">i386</span> the <span class="tt">build</span> directory structure looks like this:</p>
<div class="fragment"><div class="line">+- build</div>
<div class="line">    |</div>
<div class="line">    +- host</div>
<div class="line">    |   |</div>
<div class="line">    |   +- bin           &lt;- Native Binaries</div>
<div class="line">    |   |</div>
<div class="line">    |   +- lib           &lt;- Native Libraries</div>
<div class="line">    |   |</div>
<div class="line">    |   +- mrbgems</div>
<div class="line">    |   |</div>
<div class="line">    |   +- src</div>
<div class="line">    |</div>
<div class="line">    +- i386</div>
<div class="line">        |</div>
<div class="line">        +- bin            &lt;- Cross-compiled Binaries</div>
<div class="line">        |</div>
<div class="line">        +- include        &lt;- Header Directory</div>
<div class="line">        |</div>
<div class="line">        +- lib            &lt;- Cross-compiled Libraries</div>
<div class="line">        |</div>
<div class="line">        +- mrbgems</div>
<div class="line">        |</div>
<div class="line">        +- mrblib</div>
<div class="line">        |</div>
<div class="line">        +- src</div>
</div><!-- fragment --><p>An extra directory is created for the target platform. In case you compile for <span class="tt">i386</span> a directory called <span class="tt">i386</span> is created under the build directory.</p>
<p>The cross compilation workflow starts in the same way as the normal compilation by compiling all <em>native</em> libraries and binaries, except for we don't have <span class="tt">host/mrbc</span> directory (<span class="tt">host</span> directory itself works as placeholder for <span class="tt">mrbc</span>). Afterwards the cross compilation process proceeds like this:</p>
<ul>
<li>cross-compile all files under <span class="tt">src</span> and store result in <span class="tt">build/i386/src</span></li>
<li>create <span class="tt">build/i386/lib/libmruby_core.a</span> out of C object files</li>
<li>create <span class="tt">build/i386/mrblib/mrblib.c</span> by compiling all <span class="tt">*.rb</span> files under <span class="tt">mrblib</span> with native <span class="tt">build/host/bin/mrbc</span></li>
<li>cross-compile <span class="tt">build/i386/mrblib/mrblib.c</span> to <span class="tt">build/i386/mrblib/mrblib.o</span></li>
<li>create <span class="tt">build/i386/lib/libmruby.a</span> from object files from gems and <span class="tt">libmruby_core.a</span></li>
<li>create binary commands according to binary gems (e.g. <span class="tt">mirb</span> and <span class="tt">mruby</span>)</li>
<li>copy binaries under <span class="tt">build/host/bin</span> to <span class="tt">bin</span> directory</li>
</ul>
<div class="fragment"><div class="line"> _______________________________________________________________</div>
<div class="line">|              Native Compilation for Host System               |</div>
<div class="line">|  _____      ______      _____      ____      ____      _____  |</div>
<div class="line">| | CC  | -&gt; |AR    | -&gt; |GEN  | -&gt; |CC  | -&gt; |CC  | -&gt; |AR   | |</div>
<div class="line">| | *.c |    |core.a|    |y.tab|    |mrbc|    |*.rb|    |lib.a| |</div>
<div class="line">|  -----      ------      -----      ----      ----      -----  |</div>
<div class="line"> ---------------------------------------------------------------</div>
<div class="line">                                ||</div>
<div class="line">                               \||/</div>
<div class="line">                                \/</div>
<div class="line"> ________________________________________________________________</div>
<div class="line">|             Cross Compilation for Target System                |</div>
<div class="line">|  _____      _____      _____      ____      ______      _____  |</div>
<div class="line">| | CC  | -&gt; |AR   | -&gt; |CC   | -&gt; |CC  | -&gt; |AR    | -&gt; |CC   | |</div>
<div class="line">| | *.c |    |lib.a|    |mruby|    |mirb|    |core.a|    |mrbc | |</div>
<div class="line">|  -----      -----      -----      ----      ------      -----  |</div>
<div class="line"> ----------------------------------------------------------------</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md307"></a>
Build Configuration Examples</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md308"></a>
Minimal Library</h2>
<p>To build a minimal mruby library you need to use the Cross Compiling feature due to the reason that there are functions (e.g. stdio) which can't be disabled for the main build.</p>
<div class="fragment"><div class="line">MRuby::CrossBuild.new(&#39;minimal&#39;) do |conf|</div>
<div class="line">  conf.toolchain :gcc</div>
<div class="line">  conf.cc.defines &lt;&lt; &#39;MRB_NO_STDIO&#39;</div>
<div class="line">end</div>
</div><!-- fragment --><p>This configuration defines a cross compile build called 'minimal' which is using the GCC and compiles for the host machine. It also disables all usages of stdio and doesn't compile any binaries (e.g. <span class="tt">mrbc</span>).</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md309"></a>
Test Environment</h1>
<p>mruby's build process includes a test environment. In case you start the testing of mruby, a native binary called <span class="tt">mrbtest</span> will be generated and executed. This binary contains all test cases which are defined under <span class="tt">test/t</span>. In case of a cross-compilation an additional cross-compiled <span class="tt">mrbtest</span> binary is generated. You can copy this binary and run on your target system.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md310"></a>
Embedding <span class="tt">mruby</span> in Your Application</h1>
<p>After the build, you will get <span class="tt">libmruby.a</span>. You can link it to your application.</p>
<p>For compiler options and library path, you can use <span class="tt">mruby-config</span> command for convenience. <span class="tt">mruby-config</span> command prints the configuration used for <span class="tt">libmruby.a</span>.</p>
<div class="fragment"><div class="line">$ mruby-config --help</div>
<div class="line">Usage: mruby-config [switches]</div>
<div class="line">  switches:</div>
<div class="line">  --cc                        print compiler name</div>
<div class="line">  --cflags                    print flags passed to compiler</div>
<div class="line">  --ld                        print linker name</div>
<div class="line">  --ldflags                   print flags passed to linker</div>
<div class="line">  --ldflags-before-libs       print flags passed to linker before linked libraries</div>
<div class="line">  --libs                      print linked libraries</div>
<div class="line">  --libmruby-path             print libmruby path</div>
<div class="line">  --help                      print this help</div>
</div><!-- fragment --><p>For example, when you have a C source file (<span class="tt">c.c</span>) and try to compile and link it with <span class="tt">libmruby.a</span>, you can run the following command,</p>
<div class="fragment"><div class="line">`mruby-config --cc --cflags` c.c `mruby-config --ldflags --libs`</div>
</div><!-- fragment --><p>When you use <span class="tt">make</span>, add following lines in <span class="tt">Makefile</span></p>
<div class="fragment"><div class="line">MRB_CONFIG = &lt;path-to-mruby-config&gt;</div>
<div class="line">CFLAGS = `$(MRB_CONFIG) --cflags`</div>
<div class="line">LDFLAGS = `$(MRB_CONFIG) --ldflags`</div>
<div class="line">LIBS = `$(MRB_CONFIG) --libs`</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md311"></a>
Install</h1>
<p>To install the files in the <span class="tt">bin</span>, <span class="tt">include</span> and <span class="tt">lib</span> directories generated by the "host" build target into a system directory, do the following:</p>
<div class="fragment"><div class="line">$ rake install</div>
</div><!-- fragment --><p>If there are multiple build targets in the build configuration file, to install the products of all build targets, do the following:</p>
<div class="fragment"><div class="line">$ rake install:full</div>
</div><!-- fragment --><p>To install only one of several build targets, e.g., the "its-mine" build target, do the following:</p>
<div class="fragment"><div class="line">$ rake install:full:its-mine</div>
</div><!-- fragment --><p>To install only the executable files, do the following:</p>
<div class="fragment"><div class="line">$ rake install_bin              # only &quot;host&quot; build target</div>
<div class="line">$ rake install:bin              # all build targets</div>
<div class="line">$ rake install:bin:its-mine     # only &quot;its-mine&quot; build target</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md312"></a>
Installation Directory</h2>
<p>The installation directory is <span class="tt">/usr/local</span> for the "host" build target and <span class="tt">/usr/local/mruby/&lt;build-name&gt;</span> for the others. To change them, you can set the environment variable <span class="tt">PREFIX</span> or use <span class="tt">MRuby::Build#install_prefix = dir</span> in your build configuration file.</p>
<p>The <span class="tt">PREFIX</span> environment variable affects all build targets and changes the <span class="tt">/usr/local</span> part.</p>
<p>The <span class="tt">MRuby::Build#install_prefix</span> can be set for each individual build target. In this case, the environment variable <span class="tt">PREFIX</span> is ignored.</p>
<p>Also, if the environment variable <span class="tt">DESTDIR</span> is set, it will prepend to the path obtained by <span class="tt">install_prefix</span> to determine the final write directory. This is intended for temporary file expansion by the user's package work.</p>
<hr  />
<p>To summarize:</p>
<ul>
<li>The default value of the environment variable <span class="tt">PREFIX</span> is <span class="tt">/usr/local</span>.</li>
<li>For the "host" build target, the default value of <span class="tt">MRuby::Build#install_prefix</span> is <span class="tt">&lt;PREFIX&gt;</span>.</li>
<li>For a build target other than "host", the default value of <span class="tt">MRuby::Build#install_prefix</span> is <span class="tt">&lt;PREFIX&gt;/mruby/&lt;build-name&gt;</span>.</li>
<li>If the environment variable <span class="tt">DESTDIR</span> is set, the actual write directory is <span class="tt">&lt;DESTDIR&gt;/&lt;MRuby::Build#install_prefix&gt;</span>.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md314"></a>
Tips</h1>
<ul>
<li>If you see compilation troubles, try <span class="tt">rake clean</span> first. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
