<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BlueBox: managed_components/espressif__esp-dsp/modules/kalman/ekf_imu13states/docs Directory Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">BlueBox<span id="projectnumber">&#160;0.9</span>
   </div>
   <div id="projectbrief">BlueBox Bluetooth sink</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><b>managed_components</b></li><li class="navelem"><a href="dir_d664d8157ae9d72e0e60106055df655c.html">espressif__esp-dsp</a></li><li class="navelem"><b>modules</b></li><li class="navelem"><b>kalman</b></li><li class="navelem"><b>ekf_imu13states</b></li><li class="navelem"><a href="dir_3b9771c313cff84cbeca1d4d406a7345.html">docs</a></li>  </ul>
</div>
</div><!-- top -->
<div id="doc-content">
<div class="header">
  <div class="headertitle"><div class="title">docs Directory Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Directory dependency graph for docs:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" loading="lazy" frameborder="0" src="dir_3b9771c313cff84cbeca1d4d406a7345_dep.svg" width="150" height="107"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<h1 class="doxsection"><a class="anchor" id="autotoc_md189"></a>
Extended Kalman Filter for IMU sensor with 13 calculated states</h1>
<p>The extended Kalman filter (EKF) with 13 states designed to be used with data from common IMU sensor, like MPU9250 or MPU6050. These sensors provide gyroscope, accelerometer and magnetometer data. The sensors have measurement errors, and it's not possible to use them for calculation system attitude. For that the EKF should be used. Current implementation of EKF calculates 13 value to define the system state:</p><ol type="1">
<li>System attitude [0..3]: quaternion that describes absolute value of system attitude (w, x,y,z)</li>
<li>Gyroscope sensor errors[4..6]: bias values (x,y,z)</li>
<li>Magnetometer vector value[7..9]: absolute value of magnetometer sensor (x,y,z)</li>
<li>Magnetometer vector offset[10..12]: absolute value of magnetometer sensor offset (x,y,z) These values calculated by the EKF and stored to the X vector. Magnetometer value from the sensor has some value and offset. This information needed to calculate system attitude. Magnetometer sensor value = R*Magn_Amplitude + Magn_offset. Where R - rotation matrix from system attitude, Magn_Amplitude - real magnetometer value calculated by the EKF Magn_offset - magnetometer offset value (called deviation)</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md190"></a>
How to use EKF</h1>
<p>The EKF has two main methods: state calculation (Process(...)) and state correction (UpdateRefMeasurement() in our case). The current EKF has one main input value - is a gyroscope (gyro) angular speed. If the gyro has no bias error, then it's enough to call Process(...) method, and EKF will calculate system attitude. But, the gyro has a bias error and that's why, the UpdateRefMeasurement(...) must be called, when reference accelerometer and magnetometer values are available. After the firs start, the EKF will need some time to calculate correct gyro bias and magnetometer deviation. This is a calibration phase. To avoid this phase every time after filter started, it's better to store X vector and P matrix to the non-volatile memory, and restore them after system started. The sequence in this case will be: Init()-&gt; restore X and P values (if exist) -&gt; go to normal process</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md191"></a>
Adjustable parameters</h1>
<p>There two lists of parameters that could be adjusted: R - measurement noise covariance values, and Q - model noise matrix. The R is an array with values for diagonal matrix. Then smaller value R for reference value, then more EKF will trust for this value. In normal case, the R values should be between 0.001 and 1. The Q - is a diagonal (only values in main diagonal are important) noise matrix of state vector. This matrix define how good value in state vector X should be. </p>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
