<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BlueBox: User visible changes in &lt;tt&gt;mruby3.1&lt;/tt&gt; from &lt;tt&gt;mruby3.0&lt;/tt&gt;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">BlueBox<span id="projectnumber">&#160;0.9</span>
   </div>
   <div id="projectbrief">BlueBox Bluetooth sink</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">User visible changes in <span class="tt">mruby3.1</span> from <span class="tt">mruby3.0</span> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md449"></a></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md450"></a>
New Features</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md451"></a>
Core Language Features</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md452"></a>
Keyword Arguments</h3>
<p>CRuby3.0 compatible keyword arguments are introduced. Keyword arguments are basically separated from ordinal arguments.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md453"></a>
Other Language Enhancement</h3>
<ul>
<li>Implement endless-def <a href="https://bugs.ruby-lang.org/issues/16746">Ruby:Feature#16746</a></li>
<li>Replace <span class="tt">R-assignment</span> by <span class="tt">single-line pattern matching</span> <a href="https://bugs.ruby-lang.org/issues/15921">Ruby:Feature#15921</a></li>
<li>Support squiggly heredocs. <a href="https://github.com/mruby/mruby/pull/5246">#5246</a></li>
<li>Hash value omission <a href="https://bugs.ruby-lang.org/issues/14579">Ruby:Feature#14579</a></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md454"></a>
Configuration Options Changed</h2>
<p>Some configuration macros are available:</p>
<ul>
<li><span class="tt">MRB_WORDBOX_NO_FLOAT_TRUNCATE</span>: by default, float values are packed in the word if possible, but define this macro to allocate float values in the heap.</li>
<li><span class="tt">MRB_USE_RO_DATA_P_ETEXT</span>: define this macro if <span class="tt">_etext</span> is available on your platform.</li>
<li><span class="tt">MRB_NO_DEFAULT_RO_DATA_P</span>: define this macro to avoid using predefined <span class="tt">mrb_ro_data_p()</span> function</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md456"></a>
Updated Features</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md457"></a>
New build configurations</h2>
<p>We have added several new build configurations in the <span class="tt">build_config</span> directory.</p>
<ul>
<li><span class="tt">cross-mingw-winetest.rb</span></li>
<li><span class="tt">cross-mingw.rb</span></li>
<li><span class="tt">nintendo_switch.rb</span></li>
<li><span class="tt">serenity.rb</span></li>
<li><span class="tt">minimal</span>: minimal configuration</li>
<li><span class="tt">host-f32</span>: compiles with <span class="tt">mrb_float</span> as 32 bit <span class="tt">float</span></li>
<li><span class="tt">host-nofloat</span>: compiles with no float configuration</li>
<li><span class="tt">android_arm64_v8a.rb</span>: renamed from <span class="tt">android_arm64-v8a.rb</span></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md458"></a>
Core Libraries</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md459"></a>
New Methods</h3>
<ul>
<li><span class="tt">Array#product</span></li>
<li><span class="tt">Array#repeated_combination</span></li>
<li><span class="tt">Array#repeated_permutation</span></li>
<li><span class="tt">Kernel#__ENCODING__</span></li>
<li><span class="tt">Random.bytes</span></li>
<li><span class="tt">Random#bytes</span></li>
<li><span class="tt">String#center</span></li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md460"></a>
New Gem Enhancement</h3>
<ul>
<li><span class="tt">mrbgems/mruby-pack</span> now supports <span class="tt">M</span> directive (Q encoding)</li>
<li><span class="tt">mrbgems/mruby-pack</span> now supports <span class="tt">X</span> directive (back-up by bytes)</li>
<li><span class="tt">mrbgems/mruby-pack</span> now supports <span class="tt">@</span> directive (absolute position)</li>
<li><span class="tt">mrbgems/mruby-pack</span> now supports <span class="tt">w</span> directive (BER compression)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md461"></a>
Tools</h2>
<ul>
<li><span class="tt">mruby-config</span> now supports <span class="tt">--cc</span> and <span class="tt">--ld</span> options.</li>
<li>Remove <span class="tt">OP_</span> prefix from <span class="tt">mruby -v</span> code dump output.</li>
<li>Prohibit use of <span class="tt">OP_EXT{1,2,3}</span> by <span class="tt">mrbc</span> with <span class="tt">--no-ext-ops</span> option.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md462"></a>
Features for mruby Developer</h2>
<ul>
<li>Add new specifier <span class="tt">c</span> to <span class="tt"><a class="el" href="mruby_8h.html#a6659ff35e634812fff48bb6a7f66730e">mrb_get_args()</a></span> for receive Class/Module.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md464"></a>
Breaking Changes</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md465"></a>
Incompatibly Changed Methods</h2>
<ul>
<li><span class="tt">Kernel#printf</span> (<span class="tt">mruby-sprintf</span>) Format specifiers <span class="tt">a</span> and <span class="tt">A</span> are removed.</li>
<li><span class="tt">Kernel#puts</span> (<span class="tt">mruby-print</span>) Now expand Array arguments.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md466"></a>
mruby VM and bytecode</h2>
<p>Due to improvements in the binary format, mruby binaries are no longer backward compatible. To run the mruby binaries on mruby 3.1, recompile with the mruby 3.1 <span class="tt">mrbc</span>.</p>
<ul>
<li>Upgrade mruby VM version <span class="tt">RITE_VM_VER</span> to <span class="tt">0300</span> (means mruby 3.0 or after).</li>
<li>Upgrade mruby binary version <span class="tt">RITE_BINARY_FORMAT_VER</span> to <span class="tt">0300</span>.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md467"></a>
Reintroduced Instructions</h2>
<p><span class="tt">mruby3.0</span> removed <span class="tt">OP_EXT1</span>, <span class="tt">OP_EXT2</span>, <span class="tt">OP_EXT3</span> for operand extension. But the operand size limitations was too tight for real-world application. <span class="tt">mruby3.1</span> reintroduces those extension instructions.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md468"></a>
Removed Instructions</h2>
<p><span class="tt">mruby3.1</span> removed following instructions.</p>
<ul>
<li><span class="tt">OP_LOADL16</span></li>
<li><span class="tt">OP_LOADSYM16</span></li>
<li><span class="tt">OP_STRING16</span></li>
<li><span class="tt">OP_LAMBDA16</span></li>
<li><span class="tt">OP_BLOCK16</span></li>
<li><span class="tt">OP_METHOD16</span></li>
<li><span class="tt">OP_EXEC16</span></li>
</ul>
<p>Those instructions are no longer needed by reintroduction of extension instructions.</p>
<ul>
<li><span class="tt">OP_SENDV</span></li>
<li><span class="tt">OP_SENDVB</span></li>
</ul>
<p>Those instructions for method calls with variable number of arguments are no longer needed. They are covered by <span class="tt">OP_SEND</span> instruction with <span class="tt">n=15</span>.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md469"></a>
New Instructions</h2>
<p><span class="tt">mruby3.1</span> introduces following new instructions.</p>
<ul>
<li><span class="tt">OP_GETIDX</span>: takes 1 operands <span class="tt">R[a][a+1]</span></li>
<li><span class="tt">OP_SETIDX</span>: takes 1 operands <span class="tt">R[a][a+1]=R[a+2]</span></li>
<li><span class="tt">OP_SSEND</span>: takes 3 operands <span class="tt">a=self.b(c...)</span>; see <span class="tt">OP_SEND</span></li>
<li><span class="tt">OP_SSENDB</span>: takes 3 operands <span class="tt">a=self.b(c...){...}</span>; see <span class="tt">OP_SEND</span></li>
<li><span class="tt">OP_SYMBOL</span>: takes 2 operands <span class="tt">R[a] = intern(Pool[b])</span></li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md470"></a>
<span class="tt">OP_GETIDX</span> and <span class="tt">OP_SETIDX</span></h3>
<p>Execute <span class="tt">obj[int]</span> and <span class="tt">obj[int] = value</span> respectively, where <span class="tt">obj</span> is <span class="tt">string|array|hash</span>.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md471"></a>
<span class="tt">OP_SSEND</span> and <span class="tt">OP_SSENDB</span></h3>
<p>They are similar to <span class="tt">OP_SEND</span> and <span class="tt">OP_SENDB</span> respectively. They initialize the <span class="tt">R[a]</span> by <span class="tt">self</span> first so that we can skip one <span class="tt">OP_LOADSELF</span> instruction for each call.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md472"></a>
<span class="tt">OP_SYMBOL</span></h3>
<p>Extracts the character string placed in the pool as a symbol.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md473"></a>
Changed Instructions</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md474"></a>
<span class="tt">OP_SEND</span> and <span class="tt">OP_SENDB</span></h3>
<p>Method calling instructions are unified. Now <span class="tt">OP_SEND</span> and <span class="tt">OP_SENDB</span> (method call with a block) can support both splat arguments and keyword arguments as well.</p>
<p>The brief description of the instructions:</p>
<p>|<span class="tt">OP_SEND</span> | BBB | <span class="tt">R[a] = R[a].call(Syms[b],R[a+1..n],R[a+n+1],R[a+n+2]..nk) c=n|nk&lt;&lt;4</span> | |<span class="tt">OP_SENDB</span> | BBB | <span class="tt">R[a] = R[a].call(Syms[b],R[a+1..n],R[a+n+1..nk],R[a+n+2..nk],&amp;R[a+n+2*nk+2]) c=n|nk&lt;&lt;4</span> |</p>
<p>Operand C specifies the number of arguments. Lower 4 bits (<span class="tt">n</span>) represents the number of ordinal arguments, and higher 4 bits (<span class="tt">nk</span>) represents the number of keyword arguments. When <span class="tt">n == 15</span>, the method takes arguments packed in an array. When <span class="tt">nk == 15</span>, the method takes keyword arguments are packed in a hash.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md475"></a>
<span class="tt">OP_ARYPUSH</span></h3>
<p>Now takes 2 operands and pushes multiple entries to an array.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md476"></a>
Boxing Updated</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md477"></a>
Word Boxing</h3>
<p><span class="tt">MRB_WORD_BOXING</span> now packs floating-point numbers in the word, if the size of <span class="tt">mrb_float</span> is equal or smaller than the size of <span class="tt">mrb_int</span> by default. If the size of <span class="tt">mrb_float</span> and <span class="tt">mrb_int</span> are same, the last 2 bits in the <span class="tt">mrb_float</span> are trimmed and used as flags. If you need full precision, you need to define <span class="tt">MRB_WORDBOX_NO_FLOAT_TRUNCATE</span> as described above.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md478"></a>
NaN Boxing</h3>
<p>Previous NaN boxing packs values in NaN representation, but pointer retrievals are far more frequent than floating-point number references. So we add constant offset to NaN representation to clear higher bits of pointer representation. This representation is called "Favor Pointer" NaN Boxing.</p>
<p>Also, previous NaN boxing limit the size of <span class="tt">mrb_int</span> to 4 bytes (32 bits) to fit in NaN values. Now we allocate integer values in the heap, if the value does not fit in the 32 bit range, just like we did in Word Boxing.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md479"></a>
Constant Folding</h2>
<p>The code generator was updated to reduce the number of instructions, e.g.</p>
<div class="fragment"><div class="line">a = 2 * 5</div>
</div><!-- fragment --><p>will be interpreted as</p>
<div class="fragment"><div class="line">a = 10</div>
</div><!-- fragment --><p>In addition, we have improved peephole optimizations, for example:</p>
<div class="fragment"><div class="line">GETIV R4 :@foo</div>
<div class="line">MOVE R1 R4</div>
</div><!-- fragment --><p>to</p>
<div class="fragment"><div class="line">GETIV R1 :@foo</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md480"></a>
<span class="tt">String#hash</span> now use <span class="tt">FNV1a</span> algorithm</h2>
<p>For better and faster hash values.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md482"></a>
Major bug fixes</h1>
<ul>
<li>Fix infinite recursive call bugs in integer division <a href="https://github.com/mruby/mruby/commit/98799aa6">98799aa6</a></li>
<li>Fix to raise TypeError with super inside instance_eval / class_eval <a href="https://github.com/mruby/mruby/pull/5476">#5476</a></li>
<li>Fix to call <span class="tt">method_added</span> hooks on method definitions; <a href="https://github.com/mruby/mruby/pull/2339">#2339</a></li>
<li>Fix a potential buffer overflow in <span class="tt">time_zonename</span> <a href="https://github.com/mruby/mruby/commit/26340a88">26340a88</a></li>
<li>Fix <span class="tt">Module.instance_eval</span> bug <a href="https://github.com/mruby/mruby/pull/5528">#5528</a></li>
<li>Fix fix <span class="tt">M</span> packing bug <a href="https://github.com/mruby/mruby/commit/bfe2bd49">bfe2bd49</a></li>
<li>Fix a bug regarding attribute assignment with kargs <a href="https://github.com/mruby/mruby/commit/de2b4bd0">de2b4bd0</a></li>
<li>Fix SIGSEGV with mrbgems/mruby-method <a href="https://github.com/mruby/mruby/pull/5580">#5580</a></li>
<li>Fix print error before cleanup in <span class="tt">codegen_error()</span> <a href="https://github.com/mruby/mruby/pull/5603">#5603</a></li>
<li>Fix a bug in unpacking BER <a href="https://github.com/mruby/mruby/pull/5611">#5611</a></li>
<li>Fix a bug with numbered parameters as arguments <a href="https://github.com/mruby/mruby/pull/5605">#5605</a></li>
<li>Fix <span class="tt">mrb_ary_shift_m</span> initialization bug <a href="https://github.com/mruby/mruby/commit/27d1e013">27d1e013</a></li>
<li>Fix keyword argument with <span class="tt">super</span> <a href="https://github.com/mruby/mruby/pull/5628">#5628</a></li>
<li>Fix a bug with numbered parameters on toplevel <a href="https://github.com/mruby/mruby/commit/7e7f1b2f">7e7f1b2f</a></li>
<li>Fix keyword argument bug <a href="https://github.com/mruby/mruby/issues/5632">#5632</a></li>
<li>Fix multiple assignments in parameters <a href="https://github.com/mruby/mruby/issues/5647">#5647</a></li>
<li>Fix keyword parameters not passing through super <a href="https://github.com/mruby/mruby/issues/5660">#5660</a></li>
<li>Fix infinite loop from unclosed here-doc <a href="https://github.com/mruby/mruby/issues/5676">#5676</a></li>
<li>Fix negative integer division bug <a href="https://github.com/mruby/mruby/issues/5678">#5678</a></li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md483"></a>
CVEs</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md484"></a>
Fixed CVEs</h2>
<p>Following CVEs are fixed in this release.</p>
<ul>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2021-4110">CVE-2021-4110</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2021-4188">CVE-2021-4188</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0080">CVE-2022-0080</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0240">CVE-2022-0240</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0326">CVE-2022-0326</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0481">CVE-2022-0481</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0631">CVE-2022-0631</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0632">CVE-2022-0632</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0890">CVE-2022-0890</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-1071">CVE-2022-1071</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-1106">CVE-2022-1106</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-1201">CVE-2022-1201</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-1427">CVE-2022-1427</a></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md485"></a>
Unaffected CVEs</h2>
<p>Following CVEs do not cause problems in this release. They are fixed in the later release.</p>
<ul>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0481">CVE-2022-0481</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0525">CVE-2022-0525</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0570">CVE-2022-0570</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0614">CVE-2022-0614</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0623">CVE-2022-0623</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0630">CVE-2022-0630</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-0817">CVE-2022-0717</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-1212">CVE-2022-1212</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-1276">CVE-2022-1276</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2022-1286">CVE-2022-1286</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
